{% extends "base.html" %}

{% block title %}Upload Receipt{% endblock %}

{% block extra_css %}
<style>
    .upload-container {
        max-width: 600px;
        margin: 2rem auto;
        padding: 2rem;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .upload-form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .result {
        margin-top: 1rem;
        padding: 1rem;
        border-radius: 5px;
    }

    .success { background-color: #e7f3e7; }
    .error { background-color: #f3e7e7; }
</style>
{% endblock %}

{% block content %}
<div class="upload-container">
    <h1>Upload Receipt</h1>
    <form class="upload-form" action="{{ url_for('ocr.upload_file') }}" method="post" enctype="multipart/form-data">
        <div>
            <input type="file" name="file" accept="image/*" required>
        </div>
        <div>
            <button type="submit">Upload and Process</button>
        </div>
    </form>

    <h1>Record Voice Input</h1>
    <div class="upload-form">
        <button id="recordButton">Start Recording</button>
        <button id="stopButton" disabled>Stop Recording</button>
    </div>

    {% if message %}
        <div class="result {{ 'success' if not error else 'error' }}">
            <p>{{ message }}</p>
        </div>
    {% endif %}

    {% if json_path %}
        <div class="result success">
            <p>Processed JSON: <a href="{{ url_for('static', filename=json_path) }}">{{ json_path }}</a></p>
        </div>
    {% endif %}
</div>

<script>
    let mediaRecorder;
    let audioChunks = [];

    document.getElementById('recordButton').addEventListener('click', async () => {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();

        mediaRecorder.addEventListener('dataavailable', event => {
            audioChunks.push(event.data);
        });

        mediaRecorder.addEventListener('stop', async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            const formData = new FormData();
            formData.append('audio_data', audioBlob, 'recording.wav');

            const response = await fetch("{{ url_for('ocr.voice_input') }}", {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            if (result.success) {
                alert('Voice input processed successfully!');
                window.location.reload();
            } else {
                alert('Error processing voice input: ' + result.message);
            }
        });

        document.getElementById('recordButton').disabled = true;
        document.getElementById('stopButton').disabled = false;
    });

    document.getElementById('stopButton').addEventListener('click', () => {
        mediaRecorder.stop();
        document.getElementById('recordButton').disabled = false;
        document.getElementById('stopButton').disabled = true;
    });
</script>
{% endblock %}